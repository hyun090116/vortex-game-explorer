// Supabase Edge Function: payments
// Supabase 대시보드 → Edge Functions → New Function → 이름: "payments"
// 아래 코드를 전체 복사해서 붙여넣기

import { serve } from "https://deno.land/std@0.224.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.4";

interface GameInfo {
  title: string;
  developer?: string;
  description?: string;
  coverImage?: string;
  releaseDate?: string;
  genre?: string[];
  rating?: number;
  price?: number;
}

interface ConfirmRequestBody {
  paymentKey: string;
  orderId: string;
  amount: number;
  userId: string;
  gameInfos: GameInfo[];
  customerEmail?: string;
  customerName?: string;
}

const TOSS_SECRET_KEY = Deno.env.get("TOSS_SECRET_KEY");
const SUPABASE_URL = Deno.env.get("SUPABASE_URL");
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");

const ALLOWED_ORIGINS = [
  "http://localhost:8081",
  "https://vortex-game-explorer.vercel.app",
];

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type",
};

const buildAuthHeader = () => {
  if (!TOSS_SECRET_KEY) {
    throw new Error("TOSS_SECRET_KEY가 설정되지 않았습니다.");
  }
  return `Basic ${btoa(`${TOSS_SECRET_KEY}:`)}`;
};

const supabase = createClient(SUPABASE_URL!, SUPABASE_SERVICE_ROLE_KEY!, {
  auth: { autoRefreshToken: false, persistSession: false },
});

// 게임이 DB에 존재하는지 확인하고, 없으면 생성
const ensureGameExists = async (gameInfo: GameInfo): Promise<string> => {
  const { data: existing } = await supabase
    .from("games")
    .select("id")
    .eq("title", gameInfo.title)
    .limit(1)
    .single();

  if (existing) {
    return existing.id;
  }

  const slug = gameInfo.title
    .toLowerCase()
    .replace(/[^a-z0-9가-힣]+/g, "-")
    .replace(/(^-|-$)/g, "")
    .substring(0, 255);

  const { data: newGame, error } = await supabase
    .from("games")
    .insert({
      title: gameInfo.title,
      slug,
      description: gameInfo.description || "",
      developer: gameInfo.developer || "",
      price: Number(gameInfo.price) || 0,
      cover_image: gameInfo.coverImage || null,
      genre: Array.isArray(gameInfo.genre) ? gameInfo.genre : [],
      rating: gameInfo.rating ? Number(gameInfo.rating) / 10 : 0,
      release_date: gameInfo.releaseDate || new Date().toISOString().split("T")[0],
      status: "active",
    })
    .select("id")
    .single();

  if (error || !newGame) {
    throw new Error(`게임 생성 실패: ${error?.message || "알 수 없는 오류"}`);
  }

  return newGame.id;
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { status: 200, headers: corsHeaders });
  }

  if (req.method !== "POST") {
    return new Response(
      JSON.stringify({ message: "POST만 허용됩니다." }),
      { status: 405, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }

  let body: ConfirmRequestBody;
  try {
    body = await req.json();
  } catch {
    return new Response(
      JSON.stringify({ message: "유효하지 않은 JSON입니다." }),
      { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }

  const { paymentKey, orderId, amount, userId, gameInfos } = body;

  if (!paymentKey || !orderId || !amount || !userId || !gameInfos?.length) {
    return new Response(
      JSON.stringify({ message: "필수 필드가 누락되었습니다." }),
      { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }

  try {
    // 1. Toss 결제 승인
    const confirmRes = await fetch("https://api.tosspayments.com/v1/payments/confirm", {
      method: "POST",
      headers: {
        Authorization: buildAuthHeader(),
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        paymentKey,
        orderId,
        amount,
      }),
    });

    const confirmData = await confirmRes.json();

    if (!confirmRes.ok) {
      return new Response(JSON.stringify(confirmData), {
        status: confirmRes.status,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // 2. 각 게임마다 purchases 저장
    const purchases = [];
    for (const gameInfo of gameInfos) {
      const gameId = await ensureGameExists(gameInfo);
      const gamePrice = gameInfo.price || Math.round(amount / gameInfos.length);

      purchases.push({
        user_id: userId,
        game_id: gameId,
        price_paid: gamePrice,
        payment_method: "toss",
        transaction_id: paymentKey,
        status: "completed",
      });
    }

    const { error: insertError } = await supabase.from("purchases").insert(purchases);

    if (insertError) {
      console.error("구매 내역 저장 실패:", insertError);
      return new Response(
        JSON.stringify({ message: "구매 내역 저장 실패", error: insertError.message }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    return new Response(JSON.stringify({ success: true, ...confirmData }), {
      status: 200,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  } catch (error) {
    console.error("결제 처리 오류:", error);
    return new Response(
      JSON.stringify({
        message: "결제 처리 중 오류가 발생했습니다.",
        error: error instanceof Error ? error.message : String(error),
      }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});

